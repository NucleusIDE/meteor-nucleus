<!DOCTYPE html><html lang="en"><head><title>client/eventsync/location</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content="../../"><meta name="groc-document-path" content="client/eventsync/location"><meta name="groc-project-path" content="client/eventsync/location.js"><meta name="groc-github-url" content="https://github.com/channikhabra/meteor-nucleus"><link rel="stylesheet" type="text/css" media="all" href="../../assets/style.css"><script type="text/javascript" src="../../assets/behavior.js"></script><body><div id="meta"><div class="file-path"><a href="https://github.com/channikhabra/meteor-nucleus/blob/master/client/eventsync/location.js">client/eventsync/location.js</a></div></div><div id="document"><div class="segment"><div class="code"><div class="wrapper">LocationEvent = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(appName)</span> {</span>
  <span class="hljs-keyword">var</span> EVENT_NAME = <span class="hljs-string">'location'</span>,
      APP_NAME = appName,
      $window = NucleusClient.getWindow(APP_NAME),
      utils = NucleusEventManager.getUtils(APP_NAME);

  <span class="hljs-keyword">this</span>.initialize = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
    <span class="hljs-keyword">this</span>.overRideGoCalls();
    NucleusEventManager.addEvent($window, <span class="hljs-string">'popstate'</span>, <span class="hljs-keyword">this</span>.syncGoPushstate());
  };

  <span class="hljs-keyword">this</span>.tearDown = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
    <span class="hljs-keyword">this</span>.undoGoCallOverRide();
    NucleusEventManager.removeEvent($window, <span class="hljs-string">'popstate'</span>, <span class="hljs-keyword">this</span>.syncGoPushstate());
  };

  <span class="hljs-keyword">this</span>.overRideGoCalls = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
    <span class="hljs-keyword">if</span>($window.Router) {
      $window.Router.originalGo = $window.Router.go;
      $window.Router.go = <span class="hljs-keyword">this</span>.syncGoCall(<span class="hljs-string">'Router'</span>);
    }
    <span class="hljs-keyword">if</span>($window.MobiRouter) {
      $window.MobiRouter.originalGo = $window.MobiRouter.go;
      $window.MobiRouter.go = <span class="hljs-keyword">this</span>.syncGoCall(<span class="hljs-string">'MobiRouter'</span>);
    }
  };

  <span class="hljs-keyword">this</span>.undoGoCallOverRide = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
    <span class="hljs-keyword">if</span>($window.Router)
      $window.Router.go = $window.Router.originalGo;
    <span class="hljs-keyword">if</span>($window.MobiRouter)
      $window.MobiRouter.go = $window.MobiRouter.originalGo;
  };

  <span class="hljs-keyword">this</span>.syncGoCall = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(router)</span> {</span>
    <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
      <span class="hljs-keyword">var</span> args = <span class="hljs-built_in">Array</span>.prototype.slice.call(<span class="hljs-built_in">arguments</span>, <span class="hljs-number">0</span>);
      <span class="hljs-keyword">var</span> ret = $window[router].originalGo.apply($window[router], args);
      <span class="hljs-keyword">this</span>.pushHistory();

      <span class="hljs-keyword">if</span> (NucleusEventManager.canEmitEvents) {
        <span class="hljs-keyword">var</span> ev = <span class="hljs-keyword">new</span> NucleusEvent();

        ev.setName(EVENT_NAME);
        ev.setAppName(APP_NAME);
        ev.router = router;
        ev.args = args;
        ev.broadcast();
      } <span class="hljs-keyword">else</span> {
        NucleusEventManager.canEmitEvents = <span class="hljs-literal">true</span>;
      }

      <span class="hljs-keyword">return</span> ret;
    }.bind(<span class="hljs-keyword">this</span>);
  };

  <span class="hljs-keyword">this</span>.history = [<span class="hljs-string">'/'</span>];
  <span class="hljs-keyword">this</span>.curIndex = <span class="hljs-number">0</span>;
  <span class="hljs-keyword">this</span>.syncGoPushstate = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
    <span class="hljs-keyword">var</span> loc = <span class="hljs-keyword">this</span>;

    <span class="hljs-keyword">var</span> movedDirection = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(list, url, cursor)</span> {</span>
      <span class="hljs-keyword">if</span>(list[cursor + <span class="hljs-number">1</span>] === url) <span class="hljs-keyword">return</span> <span class="hljs-string">'forward'</span>;
      <span class="hljs-keyword">else</span> <span class="hljs-keyword">return</span> <span class="hljs-string">'back'</span>;
    };

    <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
      <span class="hljs-keyword">if</span> (NucleusEventManager.canEmitEvents) {
        <span class="hljs-keyword">var</span> hist = loc.history,
            cursor = loc.curIndex,
            url = $window.location.pathname;

        <span class="hljs-keyword">var</span> ev = <span class="hljs-keyword">new</span> NucleusEvent();
        ev.setName(EVENT_NAME);
        ev.type = <span class="hljs-string">'popstate'</span>;
        ev.setAppName(APP_NAME);

        <span class="hljs-keyword">if</span>(movedDirection(hist, url, cursor) === <span class="hljs-string">'back'</span>) {
          cursor = cursor - <span class="hljs-number">1</span>;
          loc.curIndex = cursor;

          ev.setValue(<span class="hljs-string">'back'</span>);
          ev.broadcast();
          <span class="hljs-keyword">return</span>;
        }
        <span class="hljs-keyword">else</span> {
          cursor = cursor + <span class="hljs-number">1</span>;
          loc.curIndex = cursor;

          ev.setValue(<span class="hljs-string">'forward'</span>);
          ev.broadcast();
          <span class="hljs-keyword">return</span>;
        }
      } <span class="hljs-keyword">else</span> {
        NucleusEventManager.canEmitEvents = <span class="hljs-literal">true</span>;
      }
    };
  };

  <span class="hljs-keyword">this</span>.pushHistory = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(item, cursor)</span> {</span>
    item = item || $window.location.pathname;
    cursor = cursor || <span class="hljs-keyword">this</span>.curIndex;

    <span class="hljs-keyword">var</span> len = <span class="hljs-keyword">this</span>.history.length,
        maxLen = <span class="hljs-number">20</span>,
        history = <span class="hljs-keyword">this</span>.history;

    <span class="hljs-keyword">if</span>(cursor &gt; maxLen) cursor = maxLen

    <span class="hljs-keyword">if</span>(len &lt; maxLen) {
      <span class="hljs-keyword">if</span>(cursor !== len-<span class="hljs-number">1</span>) {
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> j = <span class="hljs-number">0</span>; j &gt; cursor &amp;&amp; j &lt; len; j++) {
          history[j+<span class="hljs-number">1</span>] = history[j];
        }
      }
      history[cursor+<span class="hljs-number">1</span>] = item;
    } <span class="hljs-keyword">else</span>{
      <span class="hljs-keyword">for</span>(<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; cursor; i++) {
        history[i] = history[i+<span class="hljs-number">1</span>];
      }
      history[cursor] = item;
    }

    <span class="hljs-keyword">this</span>.history = history;
    cursor += <span class="hljs-number">1</span>;
    <span class="hljs-keyword">this</span>.curIndex = cursor;
  };

  <span class="hljs-keyword">this</span>.handleEvent = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(event)</span> {</span>
    NucleusEventManager.canEmitEvents = <span class="hljs-literal">false</span>;

    <span class="hljs-keyword">if</span>(event.type === <span class="hljs-string">'popstate'</span>) {
      <span class="hljs-keyword">var</span> action = event.value;</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>let&#39;s not go back if user is on first page</p></div></div><div class="code"><div class="wrapper">      <span class="hljs-keyword">if</span> (action === <span class="hljs-string">'back'</span> &amp;&amp; $window.history.state.initial) {
        <span class="hljs-keyword">return</span>;
      }
      $window.history[action]();
      <span class="hljs-keyword">return</span>;
    }

    <span class="hljs-keyword">var</span> router = event.router,
        args = event.args;

    <span class="hljs-keyword">return</span> $window[router].go.apply($window[router], args);
  };
};</div></div></div></div></body></html>