<!DOCTYPE html><html lang="en"><head><title>client/nucleus</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content="../"><meta name="groc-document-path" content="client/nucleus"><meta name="groc-project-path" content="client/nucleus.js"><meta name="groc-github-url" content="https://github.com/channikhabra/meteor-nucleus"><link rel="stylesheet" type="text/css" media="all" href="../assets/style.css"><script type="text/javascript" src="../assets/behavior.js"></script><body><div id="meta"><div class="file-path"><a href="https://github.com/channikhabra/meteor-nucleus/blob/master/client/nucleus.js">client/nucleus.js</a></div></div><div id="document"><div class="segment"><div class="code"><div class="wrapper"><span class="hljs-keyword">var</span> NucleusClientFactory = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
  <span class="hljs-keyword">var</span> fileTree,
      currentFile,
      currentFileContents,
      nucleusClientDep = <span class="hljs-keyword">new</span> Deps.Dependency;

  <span class="hljs-keyword">this</span>.config = {
    nucleusUrl: window.location.origin + <span class="hljs-string">'/nucleus'</span>,
    windowName: <span class="hljs-string">'Nucleus'</span>,
    clientDir: <span class="hljs-string">'client'</span>,
    serverDir: <span class="hljs-string">'server'</span>,
    suckCSSFromPackages: []
  };

  <span class="hljs-keyword">this</span>.configure = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(config)</span> {</span>
    _.extend(<span class="hljs-keyword">this</span>.config, config);
  };

  <span class="hljs-keyword">this</span>.initialize = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(config)</span> {</span>
    <span class="hljs-keyword">this</span>.configure(config);

    <span class="hljs-keyword">var</span> url = <span class="hljs-keyword">this</span>.config.nucleusUrl,
        windowName = <span class="hljs-keyword">this</span>.config.windowName,
        nucleusWindow = window.open(url, windowName, <span class="hljs-string">'height=550,width=900'</span>);

    <span class="hljs-keyword">if</span> (window.focus) { nucleusWindow.focus(); }

    FlashMessages.configure({
      autoHide: <span class="hljs-literal">false</span>,
      hideDelay: <span class="hljs-number">3000</span>,
      autoScroll: <span class="hljs-literal">true</span>
    });

    <span class="hljs-keyword">this</span>.nucleusWindow = nucleusWindow;
    <span class="hljs-keyword">this</span>.updateCSS();
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
  };

  <span class="hljs-keyword">this</span>.getScratchDoc = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
    <span class="hljs-keyword">return</span> <span class="hljs-string">'scratch'</span>;
  };

  <span class="hljs-keyword">this</span>.getWindow = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(app_name)</span> {</span>
    <span class="hljs-keyword">var</span> nucleus_window = <span class="hljs-keyword">this</span>.nucleusWindow ? <span class="hljs-keyword">this</span>.nucleusWindow : window.name === <span class="hljs-string">"Nucleus"</span> ? window : window;

    <span class="hljs-keyword">if</span>(app_name === <span class="hljs-string">"app"</span>) <span class="hljs-keyword">return</span> nucleus_window.opener ? nucleus_window.opener : nucleus_window;

    <span class="hljs-keyword">return</span> nucleus_window;
  };

  <span class="hljs-keyword">this</span>.getAppWindow = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
    <span class="hljs-keyword">return</span> window.name === <span class="hljs-string">"Nucleus"</span> ? window.opener : window;
  };

  <span class="hljs-keyword">this</span>.isClientFile = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(filepath)</span> {</span>
    <span class="hljs-keyword">var</span> clientRegex = <span class="hljs-keyword">new</span> <span class="hljs-built_in">RegExp</span>(<span class="hljs-string">"\/"</span>+<span class="hljs-keyword">this</span>.config.clientDir+<span class="hljs-string">"\/"</span>);
    <span class="hljs-keyword">return</span> clientRegex.test(filepath);
  };
  <span class="hljs-keyword">this</span>.isServerFile = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(filepath)</span> {</span>
    <span class="hljs-keyword">var</span> serverRegex = <span class="hljs-keyword">new</span> <span class="hljs-built_in">RegExp</span>(<span class="hljs-string">"\/"</span>+<span class="hljs-keyword">this</span>.config.clientDir+<span class="hljs-string">"\/"</span>);
    <span class="hljs-keyword">return</span> serverRegex.test(filepath);
  };
  <span class="hljs-keyword">this</span>.isCSSFile = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(filepath)</span> {</span>
    <span class="hljs-keyword">var</span> splitArr = filepath.split(<span class="hljs-string">"."</span>);
    <span class="hljs-keyword">return</span> splitArr[splitArr.length-<span class="hljs-number">1</span>] === <span class="hljs-string">'css'</span>;
  };

  <span class="hljs-keyword">this</span>.markDocForEval = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(nucDoc)</span> {</span>
    <span class="hljs-keyword">var</span> filepath = nucDoc.filepath,
        isClientFile = <span class="hljs-keyword">this</span>.isClientFile(filepath);
    <span class="hljs-keyword">if</span> (isClientFile || !<span class="hljs-keyword">this</span>.isServerFile(filepath) &amp;&amp; <span class="hljs-keyword">this</span>.isCSSFile(filepath)) {
      NucleusDocuments.update({_id: nucDoc._id}, {$set: {shouldEval: <span class="hljs-literal">true</span>}});
    } <span class="hljs-keyword">else</span> {
      FlashMessages.sendWarning(<span class="hljs-string">"This file can't be evaled in realtime. Changes will be visible on next deploy."</span>);
    }
  };

  <span class="hljs-keyword">this</span>.unmarkDocForEval = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(nucDoc)</span> {</span>
    NucleusDocuments.update({_id: nucDoc._id}, {$set: {shouldEval: <span class="hljs-literal">false</span>}});
  };

  <span class="hljs-keyword">this</span>.evalNucleusDoc = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(nucDoc)</span> {</span>
    <span class="hljs-keyword">var</span> filepath = nucDoc.filepath,
        doc = ShareJsDocs.findOne(nucDoc.doc_id),
        newJs = doc.data.snapshot;
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.isCSSFile(filepath))
      <span class="hljs-keyword">this</span>.updateCSS();
    <span class="hljs-keyword">else</span>
      console.log(<span class="hljs-string">"EVALING"</span>, filepath);
  };

  <span class="hljs-keyword">this</span>.getFileTree = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
    <span class="hljs-keyword">this</span>.setFileTree();
    nucleusClientDep.depend();
    <span class="hljs-keyword">return</span> fileTree;
  };
  <span class="hljs-keyword">this</span>.setFileTree = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
    <span class="hljs-keyword">var</span> makeYou = <span class="hljs-keyword">this</span>;
    Meteor.call(<span class="hljs-string">"nucleusGetFileList"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(err, res)</span> {</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>so that this.getFileTree() won&#39;t run infinitely for reactive computations</p></div></div><div class="code"><div class="wrapper">      <span class="hljs-keyword">if</span> (!_.isEqual(res, fileTree)) {
        nucleusClientDep.changed();
        fileTree = res;
      }
    });
  }.bind(<span class="hljs-keyword">this</span>);

  <span class="hljs-keyword">this</span>.getJstreeHTML = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>jstree isn&#39;t working when used with JSON from within a meteor package. So, let&#39;s create HTML (ul&gt;li) instead.
I tried creating my own simple tree, but it&#39;s turning out to be more work</p></div></div><div class="code"><div class="wrapper">    <span class="hljs-keyword">var</span> tree = <span class="hljs-keyword">this</span>.getFileTree();
    nucleusClientDep.depend();

    <span class="hljs-keyword">if</span> (! tree) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    <span class="hljs-keyword">var</span> template = <span class="hljs-string">"\
      &lt;ul&gt; \
      &lt;% _.each(tree.children, function(child) { %&gt;  \
      &lt;li class='nucleus_tree_node' id='&lt;%= child.path %&gt;' data-type='&lt;%= child.type %&gt;'&gt;&lt;%= child.name %&gt; \
      &lt;%= childFn({tree: child, childFn: childFn}) %&gt; \
    &lt;/li&gt; \
      &lt;% }) %&gt; \
    &lt;/ul&gt;"</span>;
    <span class="hljs-keyword">var</span> templateFn = _.template(template);

    <span class="hljs-keyword">var</span> html = templateFn({tree: tree, childFn: templateFn});
    <span class="hljs-keyword">return</span> html;
  };

  <span class="hljs-keyword">this</span>.getJstreeJSON = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>jstree uses a different JSON formatting then produced by Nucleus.getFileList. Here we do the conversion</p></div></div><div class="code"><div class="wrapper">    <span class="hljs-keyword">var</span> rawtree = <span class="hljs-keyword">this</span>.getFileTree();
    <span class="hljs-keyword">if</span>(! rawtree) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    <span class="hljs-keyword">var</span> setJstreeJSON = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(obj)</span> {</span>
      _.each(obj.children, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(child)</span> {</span>
        <span class="hljs-keyword">if</span> (child.name.indexOf(<span class="hljs-string">"."</span>) === <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span>; <span class="hljs-comment">//ignore hidden files/folders</span>
        jstree.push({<span class="hljs-string">"id"</span>: child.path, <span class="hljs-string">"parent"</span>: child.parent, <span class="hljs-string">"text"</span>: child.name});
        <span class="hljs-keyword">if</span> (obj.type === <span class="hljs-string">'folder'</span>) setJstreeJSON(child);
      });
    };
    <span class="hljs-keyword">var</span> jstree = [
      {<span class="hljs-string">"id"</span>: rawtree.path, <span class="hljs-string">"parent"</span>: <span class="hljs-string">"#"</span>, <span class="hljs-string">"text"</span>: rawtree.name}
    ];
    setJstreeJSON(rawtree);
    <span class="hljs-keyword">return</span> jstree;
  };

  <span class="hljs-keyword">this</span>.editFile = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(filepath, forceRefresh)</span> {</span>
    Meteor.call(<span class="hljs-string">'nucleusSetupFileForEditting'</span>, filepath, forceRefresh, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(err, res)</span> {</span>
      <span class="hljs-keyword">if</span> (err) { console.log(err); <span class="hljs-keyword">return</span>; }
      Session.set(<span class="hljs-string">"nucleus_selected_doc_id"</span>, res);

      <span class="hljs-keyword">var</span> user = NucleusUser.me();
      <span class="hljs-keyword">if</span>(!user) <span class="hljs-keyword">return</span>; <span class="hljs-comment">// this is to avoid a message in console which shows up when user is not yet logged in</span>
      user.setCwd(res);
      user.setCurrentFilepath(filepath);
    });
  };

  <span class="hljs-keyword">this</span>.saveSelectedFileToDisk = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
    <span class="hljs-keyword">var</span> selectedDocId = Session.get(<span class="hljs-string">"nucleus_selected_doc_id"</span>),
        nucDoc = NucleusDocuments.findOne({doc_id:selectedDocId}),
        client = <span class="hljs-keyword">this</span>;
    Meteor.call(<span class="hljs-string">"nucleusSaveDocToDisk"</span>, selectedDocId, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(err, res)</span> {</span>
      <span class="hljs-keyword">if</span> (err) { console.log(err); <span class="hljs-keyword">return</span>;}
      <span class="hljs-keyword">if</span>(res === <span class="hljs-number">0</span>) FlashMessages.sendWarning(<span class="hljs-string">"No Changes to Save"</span>);
      <span class="hljs-keyword">if</span>(res === <span class="hljs-number">1</span>) {client.markDocForEval(nucDoc); FlashMessages.sendSuccess(<span class="hljs-string">"File Saved Successfully"</span>);}
      <span class="hljs-keyword">if</span>(res === <span class="hljs-number">2</span>) FlashMessages.sendError(<span class="hljs-string">"Something went Wrong when Saving File"</span>);
    });
  };

  <span class="hljs-keyword">this</span>.updateCSS = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
    <span class="hljs-keyword">var</span> nucleusStyle = document.createElement(<span class="hljs-string">"style"</span>),
        window = <span class="hljs-keyword">this</span>.getAppWindow();
    <span class="hljs-keyword">if</span>(window.document.getElementById(<span class="hljs-string">"nucleus-style"</span>)) window.document.getElementById(<span class="hljs-string">"nucleus-style"</span>).remove();
    nucleusStyle.id = <span class="hljs-string">"nucleus-style"</span>;</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>clear old CSS
This works because Meteor injects only one stylesheet <link></p></div></div><div class="code"><div class="wrapper">    _.each(window.document.querySelectorAll(<span class="hljs-string">"link"</span>), <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(link)</span> {</span>
      <span class="hljs-keyword">if</span> (link.rel === <span class="hljs-string">'stylesheet'</span>) link.href = <span class="hljs-string">''</span>;
    });

    Meteor.call(<span class="hljs-string">"nucleusGetAllCSS"</span>, {packagesToInclude: <span class="hljs-keyword">this</span>.config.suckCSSFromPackages}, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(err, res)</span> {</span>
      nucleusStyle.innerHTML = res;
      window.document.head.appendChild(nucleusStyle);
    });
  };

  <span class="hljs-keyword">this</span>.getOnlineUsers = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
    <span class="hljs-keyword">return</span> NucleusUsers.find();
  };

  <span class="hljs-keyword">this</span>.clearDeadUsers = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(users)</span> {</span>
    users = users || NucleusClient.getOnlineUsers().fetch(); <span class="hljs-comment">//try to decrease db queries</span>
    <span class="hljs-keyword">var</span> nicks = _.map(users, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(user)</span> {</span>
      <span class="hljs-keyword">return</span> user.getNick();
    });
    <span class="hljs-keyword">var</span> userIds = _.map(users, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(user)</span> {</span>
      <span class="hljs-keyword">return</span> user._id;
    });</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>clear sidebar</p></div></div><div class="code"><div class="wrapper">    <span class="hljs-keyword">var</span> nicksNodes = _.map($(<span class="hljs-string">".user-status-box"</span>), <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(n)</span> {</span>
      <span class="hljs-keyword">return</span> n.getAttribute(<span class="hljs-string">'data-user-nick'</span>);
    });
    <span class="hljs-keyword">var</span> deadNicks = _.difference(nicksNodes, nicks);
    _.each(deadNicks, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(deadNick)</span> {</span>
      $(<span class="hljs-string">"[data-user-nick="</span>+deadNick+<span class="hljs-string">"]"</span>).remove();
    });</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>clear extra cursors</p></div></div><div class="code"><div class="wrapper">    <span class="hljs-keyword">var</span> deadUserCursors = _.difference(<span class="hljs-built_in">Object</span>.keys(NucleusEditor.extraCursors), userIds);
    _.each(deadUserCursors, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(deadCursor)</span> {</span>
      NucleusEditor.removeCursor(NucleusEditor.extraCursors[deadCursor]);
    });

  };

  <span class="hljs-keyword">this</span>.createNewFile = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(filepath, cb)</span> {</span>
    Meteor.call(<span class="hljs-string">"nucleusCreateNewFile"</span>, filepath, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(err, res)</span> {</span>
      <span class="hljs-keyword">if</span>(err) {cb(err); <span class="hljs-keyword">return</span>;}
      cb(<span class="hljs-literal">null</span>, res);
    });
  };

  <span class="hljs-keyword">this</span>.createNewFolder = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(filepath, cb)</span> {</span>
    Meteor.call(<span class="hljs-string">"nucleusCreateNewFolder"</span>, filepath, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(err, res)</span> {</span>
      <span class="hljs-keyword">if</span>(err) {cb(err); <span class="hljs-keyword">return</span>;}
      cb(<span class="hljs-literal">null</span>, res);
    });
  };
  <span class="hljs-keyword">this</span>.deleteFile = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(filepath, cb)</span> {</span>
    Meteor.call(<span class="hljs-string">"nucleusDeleteFile"</span>, filepath, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(err, res)</span> {</span>
      <span class="hljs-keyword">if</span>(err) {cb(err); <span class="hljs-keyword">return</span>;}
      cb(<span class="hljs-literal">null</span>, res);
    });
  };

  <span class="hljs-keyword">this</span>.renameFile = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(oldpath, newpath, cb)</span> {</span>
    Meteor.call(<span class="hljs-string">"nucleusRenameFile"</span>, oldpath, newpath, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(err, res)</span> {</span>
      <span class="hljs-keyword">if</span>(err) {cb(err); <span class="hljs-keyword">return</span>;}
      cb(<span class="hljs-literal">null</span>, res);
    });
  };

  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
};

Deps.autorun(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>EVAL LOOP</p></div></div><div class="code"><div class="wrapper">  Meteor.subscribe(<span class="hljs-string">'nucleusPublisher'</span>);
  NucleusDocuments.find({shouldEval: <span class="hljs-literal">true</span>}).forEach(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(doc)</span> {</span>
    NucleusClient.evalNucleusDoc(doc);
    NucleusClient.unmarkDocForEval(doc);
  });
});


NucleusClient = <span class="hljs-keyword">new</span> NucleusClientFactory();</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>this deletes the current user</p></div></div><div class="code"><div class="wrapper">NucleusClient.getWindow().onbeforeunload = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
  console.log(<span class="hljs-string">"UNLOADING NUCLEUS WINDOW"</span>);
  NucleusUser.me().delete();
};</div></div></div></div></body></html>